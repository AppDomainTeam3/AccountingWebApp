{% extends 'base.html' %}

    {%block title%} {{title}} {%endblock%}

    {%block content%}

    {% if sessionUser.usertype == 'manager' %}
        {% set manager = True %}
    {% endif %}
    
    <!-- Journal Action Popup Form -->
        <form id="JournalActionForm" class="mfp-hide white-popup-block" method="POST">
            <h1>Journal Action</h1>
                <p>Please provide a reason</p>
                <p>
                    {{ form.message(size=16) }}
                </p>
                <p>
                    {{ form.submit }}
                </p>
        </form>
    {% if journals %}
    <div class="container-fluid ml-1 mb-3 mt-3">
        <table class="table table-striped table-bordered mydatatable" style="width: 100%">
            <thead>
                <tr>
                    <th colspan="9">Journal Entries</th>
                </tr>
                <tr>
                    {% if manager %}
                    <th></th>
                    {% endif %}
                    <th>Journal ID</th>
                    <th>RequestorUserID</th>
                    <th>AccountName</th>
                    <th>AccountNumber</th>
                    <th>Status</th>
                    <th>Message</th>
                    <th>Debits</th>
                    <th>Credits</th>
                </tr>
            </thead>

            <tbody>
            {% for journal in journals %}
                <tr>
                    {% if manager %}
                    <td>
                        <button class="popup-with-form" href="#JournalActionForm" id="Approve_Button#{{ journal.Journal_ID }}" onclick="approve({{ journal.Journal_ID }})">Approve</button>
                        <button class="popup-with-form" href="#JournalActionForm" id="Deny_Button#{{ journal.Journal_ID }}" onclick="deny({{ journal.Journal_ID }})">Deny</button>
                    </td>
                    {% endif %}
                    <td>{{ journal.Journal_ID }}</td>
                    <td>{{ journal.RequestorUserID }}</td>
                    <td>{{ journal.AccountName }}</td>
                    <td>{{ journal.AccountNumber }}</td>
                    <td id='{{ journal.Journal_ID }}'>{{ journal.Status }}</td>
                    <td>{{ journal.Message }}</td>
                    <td>{{ journal.Debits }}</td>
                    <td>{{ journal.Credits }}</td>
                </tr>
            {% endfor %}
            </tbody>

            <tfoot>
                {% if manager %}
                <td></td>
                {% endif %}
                <th>Journal ID</th>
                <th>RequestorUserID</th>
                <th>AccountName</th>
                <th>AccountNumber</th>
                <th>Status</th>
                <th>Message</th>
                <th>Debits</th>
                <th>Credits</th>
            </tfoot>
        </table>
    </div>
    {% else %}
    <div class="container float-left">
        <h1 class="pt-2">No journals to show</h1>
    </div>
    {% endif %}
    {%endblock%}


    {%block script%}
    <script src="../static/js/jquery.magnific-popup.min.js"></script>
    <script src="../static/js/Helper.js"></script>
    <link rel="stylesheet" href="../static/css/magnific-popup.css">
    <script>
        $('.mydatatable').DataTable({
            order: [[1,'asc']],
            pagingType: 'full_numbers'
        });

        var url = "{{ api_url }}/journals/action";
        
        function approve(journalID){
            $('#JournalActionForm').submit(function(e){
                e.preventDefault();
                $.ajax({
                    url: url,
                    type: 'post',
                    data: { 
                        action: 'Approved',
                        journal_id: journalID,
                        form: $('#JournalActionForm').serialize(),
                        sessionUserID: '{{ sessionUser.id }}'
                    }
                })
                .done(function() {
                    window.location.href = "/journals";
                });
            });
        }

        function deny(journalID){
            $('#JournalActionForm').submit(function(e){
                e.preventDefault();
                $.ajax({
                    url: url,
                    type: 'post',
                    data: { 
                        action: 'Denied',
                        journal_id: journalID,
                        form: $('#JournalActionForm').serialize(),
                        sessionUserID: '{{ sessionUser.id }}'
                    }
                }).done(function() {
                    window.location.href = "/journals";
                });
            });
        }

        $(document).ready(function() {
            $('.popup-with-form').magnificPopup({
                type: 'inline',
                preloader: false,
                focus: '#name',

                // When elemened is focused, some mobile browsers in some cases zoom in
                // It looks not nice, so we disable it:
                callbacks: {
                    beforeOpen: function() {
                        if($(window).width() < 700) {
                            this.st.focus = false;
                        } 
                        else {
                            this.st.focus = '#name';
                        }
                    }
                }
            });
        });
    </script>

    
    {%endblock%}